/*
 * top-vhost v1.7.2
 * (c) hex7c0 http://supergiovane.tk/#/top-vhost
 * Licensed under GPLv3
 */
"use strict";module.exports=function(a){function b(a,b){for(var c=0,e=a.length;e>c;c++)a[c]=d(a[c]);return{reg:a,orig:b}}function c(a){var b=a;return function(a,c,d,e){for(var f=c.reg,g=0,h=f.length;h>g;g++)if(f[g].test(d))return a._headers=a._headerNames=Object.create(null),a.writeHead(b,{Location:c.orig+e}),a.end(),!0;return!1}}function d(a){var a=a.replace(/http([s]{0,1}):\/\//i,"").replace(/\*/g,"([^.]+)");return"^"!=a[0]&&(a="^"+a),new RegExp(a,k)}function e(a){try{a()}catch(b){}return!1}function f(a){return function(b,c,d){q(c,a,b.headers.host,b.url)||e(d)}}function g(a,b,c){var d=a,f=c;if(b){var g=b,h=q;return function(a,b,c){var i=a.headers.host;return d.test(i)?(f.web(a,b),!0):h(b,g,i,a.url)?!0:e(c)}}return function(a,b,c){var g=a.headers.host;return d.test(g)?(f.web(a,b),!0):e(c)}}function h(a,b,c){var d=a,f=c;if(b){var g=b,h=q;return function(a,b,c){var i=a.headers.host;return d.test(i)?(f(a,b),!0):h(b,g,i,a.url)?!0:e(c)}}return function(a,b,c){var g=a.headers.host;return d.test(g)?(f(a,b),!0):e(c)}}function i(a){var c=q,f=d,a=require("path").resolve(a),g=require("fs"),h=require("http-proxy");if(!g.existsSync(a))throw new Error(a+" not exists");return function(d,i,j){for(var l=d.headers.host,m=JSON.parse(g.readFileSync(a,"utf8")),n=0,o=m.length;o>n;n++){var p,q=m[n];k=Boolean(q.insensitive)?"i":void 0;var r=f(q.domain.source||q.domain),s=h.createProxyServer(q.proxies);if(q.redirect){if(p=b(q.redirect,q.domain.source||q.domain),r.test(l))return s.web(d,i),!0;if(c(i,p,l,d.url))return!0}if(r.test(l))return s.web(d,i),!0}return e(j)}}function j(a,e){var a=require("path").resolve(a);if(!require("fs").existsSync(a))throw new Error(a+" not exists");var j,l,m,n,o=require(a);if(k=Boolean(o.insensitive)?"i":void 0,e.domain)j=e.domain;else if(j=o.domain){if("RegExp"===j.constructor.name)j=j.source;else if("string"!=typeof j)throw new Error('invalid "domain" argument');j=d(j)}else if(!o.dynamic)throw new Error('"domain" is required');if(e.moved?m=e.moved:Array.isArray(o.redirect)===!0&&(m=b(o.redirect,e.orig||o.domain.source||o.domain)),(n=Number(o.redirectStatus))&&(q=c(n)),o.stripWWW||o.stripOnlyWWW||o.stripHTTP||o.stripHTTPS){if(n=e.orig||o.domain.source||o.domain,o.stripHTTP)return f({reg:[/./],orig:n.replace(/http:\/\//i,"https://")});if(o.stripHTTPS)return f({reg:[/./],orig:n.replace(/https:\/\//i,"http://")});if(o.stripOnlyWWW)return f({reg:[/^www./],orig:n.replace(/www./i,".")});o.stripWWW&&("object"!=typeof m?m={reg:[/^www./],orig:j}:m.reg.push(/^www./))}if(o.dynamic)return i(String(o.dynamic));if(e.framework)return h(j,m,e.framework);if(e.proxies)return g(j,m,e.proxies);if(o.proxies&&"object"==typeof o.proxies)return l=require("http-proxy").createProxyServer(o.proxies),g(j,m,l);throw new Error('"framework" or "proxies" are required')}var k,l,m,n,o,p,q=c(301),a=a||Object.create(null),r=Object.create(null);if(a.framework&&"function"==typeof a.framework?(m=a.framework,r.framework=m):a.proxies&&"object"==typeof a.proxies&&(n=require("http-proxy").createProxyServer(a.proxies),r.proxies=n),k=Boolean(a.insensitive)?"i":void 0,l=a.domain){if("RegExp"===l.constructor.name)l=l.source;else if("string"!=typeof l)throw new Error('invalid "domain" argument');l=d(l),r.domain=l,r.orig=a.domain.source||a.domain}else if(!a.dynamic&&!a.static)throw new Error('"domain" is required');if(a.file&&console.error('top-vhost > "file" option is deprecated'),Array.isArray(a.redirect)===!0&&(o=b(a.redirect,a.domain.source||a.domain),r.moved=o),(p=Number(a.redirectStatus))&&(q=c(p)),a.stripWWW||a.stripOnlyWWW||a.stripHTTP||a.stripHTTPS){if(p=a.domain.source||a.domain,a.stripHTTP)return f({reg:[/./],orig:p.replace(/http:\/\//i,"https://")});if(a.stripHTTPS)return f({reg:[/./],orig:p.replace(/https:\/\//i,"http://")});if(a.stripOnlyWWW)return f({reg:[/^www./],orig:p.replace(/www./i,".")});a.stripWWW&&("object"!=typeof o?o={reg:[/^www./],orig:l}:o.reg.push(/^www./))}if(a.dynamic)return i(String(a.dynamic));if(a.static)return j(String(a.static),r);if(m)return h(l,o,m);if(n)return g(l,o,n);throw new Error('"framework" or "proxies" are required')};
