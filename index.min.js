/*
 * top-vhost v1.6.0
 * (c) hex7c0 https://github.com/hex7c0/top-vhost/
 * Licensed under GPLv3
 */
"use strict";function builder(a,b){for(var c=0,d=a.length;d>c;c++)a[c]=expression(a[c]);return{reg:a,orig:b}}function redirect_body(a){var b=a;return function(a,c,d,e){for(var f=c.reg,g=0,h=f.length;h>g;g++)if(f[g].test(d))return a._headers=a._headerNames=Object.create(null),a.writeHead(b,{Location:c.orig+e}),a.end(),!0;return!1}}function expression(a){var a=a.replace(/http([s]{0,1}):\/\//i,"").replace(/\*/g,"([^.]+)");return"^"!=a[0]&&(a="^"+a),new RegExp(a,insensitive)}function end(a){try{a()}catch(b){}return!1}function strip(a){var b=a,c=redirect;return function(a,d){return c(d,b,"*",a.url)}}function proxies(a,b,c){var d=a,e=c;if(b){var f=b,g=redirect;return function(a,b,c){var h=a.headers.host;return d.test(h)?(e.web(a,b),!0):g(b,f,h,a.url)?!0:end(c)}}return function(a,b,c){var f=a.headers.host;return d.test(f)?(e.web(a,b),!0):end(c)}}function framework(a,b,c){var d=a,e=c;if(b){var f=b,g=redirect;return function(a,b,c){var h=a.headers.host;return d.test(h)?(e(a,b),!0):g(b,f,h,a.url)?!0:end(c)}}return function(a,b,c){var f=a.headers.host;return d.test(f)?(e(a,b),!0):end(c)}}function dynamics(a){var b=redirect,c=expression,a=require("path").resolve(a),d=require("fs"),e=require("http-proxy");if(!d.existsSync(a))throw new Error(a+" not exists");return function(f,g,h){for(var i=f.headers.host,j=JSON.parse(d.readFileSync(a,"utf8")),k=0,l=j.length;l>k;k++){var m,n=j[k];insensitive=Boolean(n.insensitive)?"i":void 0;var o=c(n.domain.source||n.domain),p=e.createProxyServer(n.proxies);if(n.redirect){if(m=builder(n.redirect,n.domain.source||n.domain),o.test(i))return p.web(f,g),!0;if(b(g,m,i,f.url))return!0}else if(o.test(i))return p.web(f,g),!0}return end(h)}}function statics(a,b){var a=require("path").resolve(a);if(!require("fs").existsSync(a))throw new Error(a+" not exists");var c,d,e,f,g=require(a);if(insensitive=Boolean(g.insensitive)?"i":void 0,b.domain)c=b.domain;else if(c=g.domain){if("RegExp"==c.constructor.name)c=c.source;else if("string"!=typeof c)throw new Error('invalid "domain" argument');c=expression(c)}else if(!g.dynamic)throw new Error('"domain" is required');if(b.moved?e=b.moved:1==Array.isArray(g.redirect)&&(e=builder(g.redirect,b.orig||g.domain.source||g.domain)),(f=Number(g.redirectStatus))&&(redirect=redirect_body(f)),g.stripWWW||g.stripHTTP||g.stripHTTPS){if(f=b.orig||g.domain.source||g.domain,g.stripHTTP)return strip({reg:[/./],orig:f.replace(/http:\/\//i,"https://")});if(g.stripHTTPS)return strip({reg:[/./],orig:f.replace(/https:\/\//i,"http://")});g.stripWWW&&("object"!=typeof e?e={reg:[/^www./],orig:c}:e.reg.push(/^www./))}if(g.dynamic)return dynamics(String(g.dynamic));if(b.framework)return framework(c,e,b.framework);if(b.proxies)return proxies(c,e,b.proxies);if(g.proxies&&"object"==typeof g.proxies)return d=require("http-proxy").createProxyServer(g.proxies),proxies(c,e,d);throw new Error('"framework" or "proxies" are required')}var redirect=redirect_body(301),insensitive;module.exports=function(a){var b,c,d,e,f,a=a||Object.create(null),g=Object.create(null);if(a.framework&&"function"==typeof a.framework?(c=a.framework,g.framework=c):a.proxies&&"object"==typeof a.proxies&&(d=require("http-proxy").createProxyServer(a.proxies),g.proxies=d),insensitive=Boolean(a.insensitive)?"i":void 0,b=a.domain){if("RegExp"==b.constructor.name)b=b.source;else if("string"!=typeof b)throw new Error('invalid "domain" argument');b=expression(b),g.domain=b,g.orig=a.domain.source||a.domain}else if(!a.dynamic&&!a.static)throw new Error('"domain" is required');if(a.file&&console.error('top-vhost > "file" option is deprecated'),1==Array.isArray(a.redirect)&&(e=builder(a.redirect,a.domain.source||a.domain),g.moved=e),(f=Number(a.redirectStatus))&&(redirect=redirect_body(f)),a.stripWWW||a.stripHTTP||a.stripHTTPS){if(f=a.domain.source||a.domain,a.stripHTTP)return strip({reg:[/./],orig:f.replace(/http:\/\//i,"https://")});if(a.stripHTTPS)return strip({reg:[/./],orig:f.replace(/https:\/\//i,"http://")});a.stripWWW&&("object"!=typeof e?e={reg:[/^www./],orig:b}:e.reg.push(/^www./))}if(a.dynamic)return dynamics(String(a.dynamic));if(a.static)return statics(String(a.static),g);if(c)return framework(b,e,c);if(d)return proxies(b,e,d);throw new Error('"framework" or "proxies" are required')};