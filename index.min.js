"use strict";function vhost(a){function b(a,b){for(var c=0,e=a.length;e>c;c++)a[c]=d(a[c]);return{reg:a,orig:b}}function c(a){var b=a;return function(a,c,d,e){for(var f=c.reg,g=0,h=f.length;h>g;g++)if(f[g].test(d))return a._headers=a._headerNames=Object.create(null),a.writeHead(b,{Location:c.orig+e}),a.end(),!0;return!1}}function d(a){var b=a.replace(/http([s]{0,1}):\/\//i,"").replace(/\*/g,"([^.]+)");return"^"!=b[0]&&(b="^"+b),new RegExp(b,k)}function e(a){return a?a():!1}function f(a){return function(b,c,d){q(c,a,b.headers.host,b.url)||e(d)}}function g(a,b,c){var d=a,f=c;if(b){var g=b,h=q;return function(a,b,c){var i=a.headers.host;return d.test(i)?(f.web(a,b),!0):h(b,g,i,a.url)?!0:e(c)}}return function(a,b,c){var g=a.headers.host;return d.test(g)?(f.web(a,b),!0):e(c)}}function h(a,b,c){var d=a,f=c;if(b){var g=b,h=q;return function(a,b,c){var i=a.headers.host;return d.test(i)?(f(a,b),!0):h(b,g,i,a.url)?!0:e(c)}}return function(a,b,c){var g=a.headers.host;return d.test(g)?(f(a,b),!0):e(c)}}function i(a){var c=q,f=d,g=require("path").resolve(a),h=require("fs"),i=require("http-proxy");if(!h.existsSync(g))throw new Error(g+" not exists");return function(a,d,j){for(var l=a.headers.host,m=JSON.parse(h.readFileSync(g,"utf8")),n=0,o=m.length;o>n;n++){var p,q=m[n];k=Boolean(q.insensitive)?"i":void 0;var r=f(q.domain.source||q.domain),s=i.createProxyServer(q.proxies);if(q.redirect){if(p=b(q.redirect,q.domain.source||q.domain),r.test(l))return s.web(a,d),!0;if(c(d,p,l,a.url))return!0}if(r.test(l))return s.web(a,d),!0}return e(j)}}function j(a,e){var j=require("path").resolve(a);if(!require("fs").existsSync(j))throw new Error(j+" not exists");var l,m,n,o,p=require(j);if(k=Boolean(p.insensitive)?"i":void 0,e.domain)l=e.domain;else if(l=p.domain){if("RegExp"===l.constructor.name)l=l.source;else if("string"!=typeof l)throw new Error('invalid "domain" argument');l=d(l)}else if(!p.dynamic)throw new Error('"domain" is required');if(e.moved?n=e.moved:Array.isArray(p.redirect)===!0&&(n=b(p.redirect,e.orig||p.domain.source||p.domain)),(o=Number(p.redirectStatus))&&(q=c(o)),p.stripWWW||p.stripOnlyWWW||p.stripHTTP||p.stripHTTPS){if(o=e.orig||p.domain.source||p.domain,p.stripHTTP)return f({reg:[/./],orig:o.replace(/http:\/\//i,"https://")});if(p.stripHTTPS)return f({reg:[/./],orig:o.replace(/https:\/\//i,"http://")});if(p.stripOnlyWWW)return f({reg:[/^www./],orig:o.replace(/www./i,".")});p.stripWWW&&("object"!=typeof n?n={reg:[/^www./],orig:l}:n.reg.push(/^www./))}if(p.dynamic)return i(String(p.dynamic));if(e.framework)return h(l,n,e.framework);if(e.proxies)return g(l,n,e.proxies);if(p.proxies&&"object"==typeof p.proxies)return m=require("http-proxy").createProxyServer(p.proxies),g(l,n,m);throw new Error('"framework" or "proxies" are required')}var k,l,m,n,o,p,q=c(301),r=a||Object.create(null),s=Object.create(null);if(r.framework&&"function"==typeof r.framework?(m=r.framework,s.framework=m):r.proxies&&"object"==typeof r.proxies&&(n=require("http-proxy").createProxyServer(r.proxies),s.proxies=n),k=Boolean(r.insensitive)?"i":void 0,l=r.domain){if("RegExp"===l.constructor.name)l=l.source;else if("string"!=typeof l)throw new Error('invalid "domain" argument');l=d(l),s.domain=l,s.orig=r.domain.source||r.domain}else if(!r.dynamic&&!r["static"])throw new Error('"domain" is required');if(r.file&&console.info('top-vhost > "file" option is deprecated'),Array.isArray(r.redirect)===!0&&(o=b(r.redirect,r.domain.source||r.domain),s.moved=o),(p=Number(r.redirectStatus))&&(q=c(p)),r.stripWWW||r.stripOnlyWWW||r.stripHTTP||r.stripHTTPS){if(p=r.domain.source||r.domain,r.stripHTTP)return f({reg:[/./],orig:p.replace(/http:\/\//i,"https://")});if(r.stripHTTPS)return f({reg:[/./],orig:p.replace(/https:\/\//i,"http://")});if(r.stripOnlyWWW)return f({reg:[/^www./],orig:p.replace(/www./i,".")});r.stripWWW&&("object"!=typeof o?o={reg:[/^www./],orig:l}:o.reg.push(/^www./))}if(r.dynamic)return i(String(r.dynamic));if(r["static"])return j(String(r["static"]),s);if(m)return h(l,o,m);if(n)return g(l,o,n);throw new Error('"framework" or "proxies" are required')}module.exports=vhost;
